<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Sapporo Industrial VFD v131.7</title>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #000;
            --iron-panel: #060608;
            --led-dim-grad: linear-gradient(180deg, #1a1a1c 0%, #080809 100%);
            --glow-core: #ffffff;
            --glow-main: #ff9d00; 
            --glow-outer: #ff3300;
            --discharge: 0 0 10px var(--glow-core), 0 0 20px var(--glow-main), 0 0 35px var(--glow-outer);
            --base-font-size: 2.2vh; 
            --heavy-border: 4px solid #2a2a2a; /* 二重線を防ぐ太線設定 */
            --thin-border: 1px solid #222;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background-color: var(--bg-color); width: 100vw; height: 100vh; overflow: hidden; display: flex; flex-direction: column; font-family: 'DotGothic16', sans-serif; color: #fff; }

        .bezel { background: var(--iron-panel); position: relative; flex-shrink: 0; border: var(--heavy-border); }
        .digit { position: relative; flex-shrink: 0; margin-right: 0.8vw; } 
        .seg { position: absolute; background: var(--led-dim-grad); border-radius: 1px; }
        .seg-h { width: 74%; height: 10%; left: 13%; } .seg-v { width: 15%; height: 38%; } 
        .seg-a { top: 2%; } .seg-b { top: 6%; right: 2%; } .seg-c { bottom: 6%; right: 2%; }
        .seg-d { bottom: 2%; } .seg-e { bottom: 6%; left: 2%; } .seg-f { top: 6%; left: 2%; }
        .seg-g { top: 45%; width: 64%; height: 10%; left: 18%; } 
        .on { background: var(--glow-core) !important; box-shadow: var(--discharge); z-index: 2; }

        /* TOP SECTION */
        #top-section { height: 38vh; display: flex; align-items: center; justify-content: center; border-bottom: none; }
        .clock-wrapper { display: flex; align-items: flex-end; transform: scale(0.85); } 
        .d-lg { width: 13vw; height: 30vh; } .d-sm { width: 3.5vw; height: 11vh; }  
        .dot-unit { background: var(--led-dim-grad); border-radius: 50%; margin-right: 1.2vw; }
        .dot-date, .dot-time { background: var(--glow-core); box-shadow: var(--discharge); }
        .dot-date { width: 0.7vw; height: 0.7vw; margin-bottom: 0.5vh; } 
        .dot-time { width: 2.1vw; height: 2.1vw; } 
        .colon-box { display: flex; flex-direction: column; gap: 6vh; margin-bottom: 5vh; padding: 0 1vw; }

        /* MID SECTION */
        #mid-section { height: 48vh; display: flex; flex-direction: column; background: #000; border-top: none; }
        .h-row-unified { display: flex; height: 6vh; background: #000; border-bottom: var(--heavy-border); }
        .h-25 { width: 25%; font-size: var(--base-font-size); font-weight: bold; display: flex; align-items: center; justify-content: center; color: #fff; }
        .h-50 { width: 50%; background: #080808; display: flex; align-items: center; justify-content: center; border-left: var(--heavy-border); border-right: var(--heavy-border); gap: 1vw; }
        .upd-label { font-size: 1.8vh; color: #fff; font-weight: bold; }
        .d-upd { width: 1.8vw; height: 3.5vh; margin-right: 0.3vw !important; }
        .colon-upd { color: #fff; font-weight: bold; font-size: 2vh; padding: 0 2px; }

        .weather-grid { display: grid; grid-template-columns: 1fr 1fr; flex-grow: 1; }
        .card { display: flex; flex-direction: column; border-right: var(--heavy-border); }
        .card:last-child { border-right: none; }

        .w-main-row { height: 22vh; display: flex; align-items: center; border-bottom: var(--thin-border); }
        .w-visual { width: 45%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; border-right: var(--thin-border); }
        .w-icon { height: 7vh; font-size: 6.5vh; margin-bottom: 1vh; color: #fff; text-shadow: var(--discharge); }
        .w-text { font-size: 1.8vh; font-weight: bold; text-align: center; color: #fff; padding: 0 0.5vw; }
        .w-stats { width: 55%; display: flex; flex-direction: column; gap: 1.5vh; align-items: center; justify-content: center; }
        
        .temp-line { display: flex; align-items: center; width: 100%; justify-content: center; }
        .label-box { font-size: 1.6vh; font-weight: bold; padding: 2px 4px; min-width: 4vw; text-align: center; border: 1px solid #fff; margin-right: 1vw; color: #fff; }
        .hi-label { background: rgba(255,157,0,0.3); } 

        .prob-section { display: flex; flex-direction: column; flex-grow: 1; border-top: var(--thin-border); }
        .prob-main-title { background: #0a0a0a; color: #fff; font-size: 1.4vh; height: 3vh; line-height: 3vh; text-align: center; letter-spacing: 0.4em; border-bottom: var(--thin-border); }
        .w-prob-grid { display: grid; grid-template-columns: repeat(4, 1fr); flex-grow: 1; }
        .prob-item { border-right: var(--thin-border); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.5vh; padding: 0.5vh; }
        .prob-item:last-child { border-right: none; }
        .prob-label { font-size: 1.4vh; color: #fff; font-weight: bold; }
        .prob-digits-row { display: flex; justify-content: center; align-items: center; width: 100%; }

        /* BOTTOM SECTION */
        #bot-section { height: 12vh; display: flex; align-items: center; border-top: none; }
        .ticker { white-space: nowrap; font-size: 6vh; color: #fff; line-height: 12vh; text-shadow: var(--discharge); position: absolute; left: 0; will-change: transform; }
        @keyframes ticker-anim { from { transform: translateX(100vw); } to { transform: translateX(-100%); } }

        /* Admin UI */
        #admin { position: fixed; bottom: 10px; right: 10px; opacity: 0; padding: 20px; transition: 0.3s; z-index: 500; }
        #admin:hover { opacity: 1; }
        #admin button { background: #000; color: #fff; border: 1px solid #fff; padding: 5px 10px; font-family: 'DotGothic16'; cursor: pointer; }
        #overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; align-items: center; justify-content: center; }
        #editor-panel { background: #111; border: 2px solid #fff; width: 80%; max-width: 500px; padding: 20px; }
        input { background: #000; border: 1px solid #444; color: #fff; padding: 10px; width: 100%; margin: 5px 0; font-family: 'DotGothic16'; }

        .d-temp { width: 2.2vw; height: 6.5vh; } 
        .d-prob { width: 1.6vw; height: 4vh; margin-right: 0.2vw !important; } 
    </style>
</head>
<body>

    <div id="top-section" class="bezel">
        <div class="clock-wrapper">
            <div id="date-group" style="display:flex; align-items:flex-end; padding-right:2vw;"></div>
            <div id="time-group" style="display:flex; align-items:flex-end;"></div>
            <div id="sec-group" style="display:flex; align-items:flex-end; margin-left:1.5vw;"></div>
        </div>
    </div>

    <div id="mid-section" class="bezel">
        <div class="h-row-unified">
            <div class="h-25">TODAY</div>
            <div class="h-50">
                <span class="upd-label">SAPPORO</span>
                <div id="upd-time-vfd" style="display:flex; align-items:center;"></div>
                <span class="upd-label">UPDATED</span>
            </div>
            <div class="h-25">TOMORROW</div>
        </div>
        <div class="weather-grid" id="weatherGrid"></div>
    </div>

    <div id="bot-section" class="bezel"><div class="ticker" id="ticker-text"></div></div>

    <div id="admin"><button onclick="openEditor()">EDIT</button></div>

    <div id="overlay">
        <div id="editor-panel">
            <h3 style="margin-bottom:15px; color:#fff;">TICKER SETTINGS</h3>
            <input type="text" id="t1" placeholder="Label 1"><input type="text" id="b1" placeholder="Message 1">
            <input type="text" id="t2" placeholder="Label 2"><input type="text" id="b2" placeholder="Message 2">
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px;">
                <button onclick="closeEditor()" style="padding:10px; color:#fff; background:#333; border:none;">CANCEL</button>
                <button onclick="saveData()" style="padding:10px; background:#fff; color:#000; border:none;">SAVE</button>
            </div>
        </div>
    </div>

    <script>
        const MAP = {'0':[1,1,1,1,1,1,0],'1':[0,1,1,0,0,0,0],'2':[1,1,0,1,1,0,1],'3':[1,1,1,1,0,0,1],'4':[0,1,1,0,0,1,1],'5':[1,0,1,1,0,1,1],'6':[1,0,1,1,1,1,1],'7':[1,1,1,0,0,0,0],'8':[1,1,1,1,1,1,1],'9':[1,1,1,1,0,1,1],'-':[0,0,0,0,0,0,1],' ':[0,0,0,0,0,0,0]};
        const STORAGE_KEY = 'vfd_multi_ticker_v127';

        function build(cls) {
            let h = `<div class="digit ${cls}">`;
            ['a','b','c','d','e','f','g'].forEach(s => h += `<div class="seg seg-${s} ${['a','d','g'].includes(s)?'seg-h':'seg-v'}"></div>`);
            return h + `</div>`;
        }
        function draw(parent, str) {
            if (!parent) return;
            const ds = parent.querySelectorAll('.digit');
            const ts = String(str).padStart(ds.length, ' ');
            for(let i=0; i<ds.length; i++) {
                const pat = MAP[ts[i]] || MAP[' '];
                ds[i].querySelectorAll('.seg').forEach((s, idx) => { s.classList.toggle('on', !!pat[idx]); });
            }
        }
        function tick() {
            const n = new Date();
            draw(document.getElementById('date-group'), String(n.getFullYear()).slice(-2)+String(n.getMonth()+1).padStart(2,'0')+String(n.getDate()).padStart(2,'0'));
            draw(document.getElementById('time-group'), String(n.getHours()).padStart(2,'0')+String(n.getMinutes()).padStart(2,'0'));
            draw(document.getElementById('sec-group'), String(n.getSeconds()).padStart(2,'0'));
        }

        async function fetchWeather() {
            try {
                const res = await fetch("https://www.jma.go.jp/bosai/forecast/data/forecast/016000.json");
                if (!res.ok) throw new Error("HTTP Error");
                const data = await res.json();
                
                const rd = new Date(data[0].reportDatetime);
                draw(document.getElementById('upd-time-vfd'), rd.getHours().toString().padStart(2,'0')+rd.getMinutes().toString().padStart(2,'0'));

                const weatherData = data[0].timeSeries[0].areas[0];
                const popSeries = data[0].timeSeries[1].areas[0];
                const tempSeries = data[0].timeSeries[2].areas[0];
                const grid = document.getElementById('weatherGrid');
                let html = ""; const dayData = [];

                for(let i=0; i<2; i++) {
                    const target = new Date(); target.setDate(target.getDate() + i);
                    const tY = target.getFullYear(), tM = target.getMonth(), tD = target.getDate();
                    
                    let weatherText = "---";
                    data[0].timeSeries[0].timeDefines.forEach((tw, idx) => {
                        const d = new Date(tw); if(d.getFullYear()===tY && d.getMonth()===tM && d.getDate()===tD) weatherText = weatherData.weathers[idx];
                    });
                    const icon = weatherText.includes('雪') ? '❄️' : weatherText.includes('雨') ? '☔' : weatherText.includes('曇') ? '☁️' : '☀️';

                    let maxT = "--", minT = "--";
                    data[0].timeSeries[2].timeDefines.forEach((tt, idx) => {
                        const d = new Date(tt);
                        if(d.getFullYear()===tY && d.getMonth()===tM && d.getDate()===tD) {
                            const val = tempSeries.temps[idx];
                            if(val !== undefined && val !== null) {
                                if(d.getHours() >= 9 && d.getHours() <= 18) maxT = val; else minT = val;
                            }
                        }
                    });

                    let pops = ["--", "--", "--", "--"];
                    data[0].timeSeries[1].timeDefines.forEach((tp, idx) => {
                        const d = new Date(tp);
                        if(d.getFullYear()===tY && d.getMonth()===tM && d.getDate()===tD) {
                            const hr = d.getHours();
                            const val = popSeries.pops[idx];
                            if(hr === 0) pops[0]=val; else if(hr === 6) pops[1]=val; else if(hr === 12) pops[2]=val; else if(hr === 18) pops[3]=val;
                        }
                    });

                    dayData.push({maxT, minT, pops});
                    const loLine = (i === 0) ? "" : `<div class="temp-line"><div class="label-box">LO</div><div id="lo-${i}" style="display:flex;">${build('d-temp').repeat(3)}</div></div>`;
                    
                    html += `<div class="card"><div class="w-main-row"><div class="w-visual"><div class="w-icon">${icon}</div><div class="w-text">${weatherText}</div></div><div class="w-stats"><div class="temp-line"><div class="label-box hi-label">HI</div><div id="hi-${i}" style="display:flex;">${build('d-temp').repeat(3)}</div></div>${loLine}</div></div><div class="prob-section"><div class="prob-main-title">降水確率</div><div class="w-prob-grid">${pops.map((p,pi)=>`<div class="prob-item"><span class="prob-label">${pi*6}-${(pi+1)*6}</span><div id="p-row-${i}-${pi}" class="prob-digits-row">${build('d-prob').repeat(3)}</div></div>`).join('')}</div></div></div>`;
                }
                grid.innerHTML = html;
                setTimeout(() => {
                    dayData.forEach((d, i) => {
                        draw(document.getElementById(`hi-${i}`), d.maxT); 
                        if(i !== 0) draw(document.getElementById(`lo-${i}`), d.minT);
                        d.pops.forEach((p, pi) => draw(document.getElementById(`p-row-${i}-${pi}`), p));
                    });
                }, 100);
            } catch (e) { console.warn("Fetch failed.", e); }
        }

        function updateScheduler() {
            const now = new Date();
            if (now.getHours() % 2 !== 0 && now.getMinutes() === 5) fetchWeather();
        }

        function openEditor() {
            const stored = localStorage.getItem(STORAGE_KEY);
            const data = stored ? JSON.parse(stored) : [{t:"INFO", b:"SYSTEM ACTIVE"}, {t:"",b:""}];
            document.getElementById('t1').value = data[0]?.t || ""; document.getElementById('b1').value = data[0]?.b || "";
            document.getElementById('overlay').style.display = 'flex';
        }
        function closeEditor() { document.getElementById('overlay').style.display = 'none'; }
        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify([{t:document.getElementById('t1').value, b:document.getElementById('b1').value}, {t:document.getElementById('t2').value, b:document.getElementById('b2').value}]));
            closeEditor(); initTicker();
        }
        function initTicker() {
            const ticker = document.getElementById('ticker-text');
            const stored = localStorage.getItem(STORAGE_KEY);
            const data = stored ? JSON.parse(stored) : [{t:"INFO", b:"INDUSTRIAL VFD SYSTEM ACTIVE"}];
            ticker.innerText = data.map(i => i.t ? `【${i.t}】${i.b}` : i.b).filter(s => s).join(" 　 ");
            const duration = (window.innerWidth + ticker.offsetWidth) / 180;
            ticker.style.animation = `ticker-anim ${duration}s linear infinite`;
        }

        window.onload = () => {
            document.getElementById('date-group').innerHTML = build('d-sm').repeat(2)+'<div class="dot-unit dot-date on"></div>'+build('d-sm').repeat(2)+'<div class="dot-unit dot-date on"></div>'+build('d-sm').repeat(2);
            document.getElementById('time-group').innerHTML = build('d-lg').repeat(2)+'<div class="colon-box"><div class="dot-unit dot-time on"></div><div class="dot-unit dot-time on"></div></div>'+build('d-lg').repeat(2);
            document.getElementById('sec-group').innerHTML = build('d-sm').repeat(2);
            document.getElementById('upd-time-vfd').innerHTML = build('d-upd').repeat(2)+'<div class="colon-upd">:</div>'+build('d-upd').repeat(2);
            tick(); setInterval(tick, 1000); fetchWeather(); setInterval(updateScheduler, 60000); initTicker();
        };
    </script>
</body>
</html>
