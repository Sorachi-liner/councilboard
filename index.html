<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Sapporo Industrial VFD v131.46 (UI Stabilization)</title>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #000;
            --iron-panel: #060608;
            --led-dim-grad: linear-gradient(180deg, #1a1a1c 0%, #080809 100%);
            --glow-core: #ffffff;
            --glow-main: #ff9d00; 
            --glow-outer: #ff3300;
            --discharge: 0 0 10px var(--glow-core), 0 0 20px var(--glow-main), 0 0 35px var(--glow-outer);
            --border-main: 2px solid #333;
            --section-gap: 8px solid #444;
            --ui-label-size: 2.4vh; 
            --header-font-size: 3.2vh;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-weight: normal !important; }
        body { background-color: var(--bg-color); width: 100vw; height: 100vh; overflow: hidden; display: flex; flex-direction: column; font-family: 'DotGothic16', sans-serif; color: #fff; }

        .bezel { background: var(--iron-panel); box-shadow: inset 0 0 40px #000; margin: 4px; position: relative; flex-shrink: 0; border: 2px solid #1a1a1a; }
        
        /* 7-SEGMENT CORE */
        .digit { position: relative; flex-shrink: 0; margin-right: 0.8vw; } 
        .seg { position: absolute; background: var(--led-dim-grad); border-radius: 1px; }
        .seg-h { width: 74%; height: 10%; left: 13%; } .seg-v { width: 15%; height: 38%; } 
        .seg-a { top: 2%; } .seg-b { top: 6%; right: 2%; } .seg-c { bottom: 6%; right: 2%; }
        .seg-d { bottom: 2%; } .seg-e { bottom: 6%; left: 2%; } .seg-f { top: 6%; left: 2%; }
        .seg-g { top: 45%; width: 64%; height: 10%; left: 18%; } 
        .on { background: var(--glow-core) !important; box-shadow: var(--discharge); z-index: 2; }
        .dot-unit { background: var(--led-dim-grad); border-radius: 50%; }

        /* CLOCK SECTION (30%) */
        #top-section { height: 30vh; display: flex; align-items: center; justify-content: center; }
        .clock-wrapper { display: flex; align-items: flex-end; transform: scale(0.9); } 
        .d-lg { width: 11vw; height: 22vh; } .d-sm { width: 3.2vw; height: 9vh; }  
        .dot-date { width: 0.6vw; height: 0.6vw; margin-bottom: 0.5vh; margin-right: 0.8vw; } 
        .dot-time { width: 1.8vw; height: 1.8vw; } 
        .colon-box { display: flex; flex-direction: column; gap: 6vh; margin-bottom: 3.5vh; padding: 0 1vw; }

        /* WEATHER SECTION (60%) - GRID STABILIZED */
        #mid-section { height: 60vh; display: flex; flex-direction: column; border-top: var(--section-gap); border-bottom: var(--section-gap); }
        .h-row { display: flex; height: 7vh; background: #000; border-bottom: var(--border-main); }
        .h-50 { width: 50%; font-size: var(--header-font-size); display: flex; align-items: center; justify-content: center; letter-spacing: 0.8em; color: #666; }
        .h-50.active { color: #fff; }

        .weather-grid { display: grid; grid-template-columns: 1fr 1fr; flex-grow: 1; }
        .card { border-right: var(--border-main); display: flex; flex-direction: column; height: 100%; position: relative; }
        .card:last-child { border-right: none; }
        
        .w-main-row { display: flex; align-items: center; height: 65%; padding: 1vh 0; }
        .w-visual { width: 40%; display: flex; flex-direction: column; justify-content: center; align-items: center; border-right: 1px solid #222; height: 80%; }
        .w-icon { font-size: 8vh; margin-bottom: 1vh; color: transparent; text-shadow: 0 0 0 white, 0 0 20px var(--glow-main); }
        .w-text { font-size: var(--ui-label-size); text-align: center; color: #aaa; width: 90%; word-break: break-all; }
        
        .w-stats { width: 60%; display: flex; flex-direction: column; gap: 2vh; align-items: flex-end; padding-right: 2vw; }
        .temp-line { display: flex; align-items: center; }
        .label-box { font-size: 2vh; padding: 2px 8px; min-width: 5vw; text-align: center; margin-right: 1vw; }
        .hi-label { color: #000; background: var(--glow-main); } 
        .lo-label { color: #000; background: #fff; } 
        .d-temp { width: 3.2vw; height: 9vh; }

        .footer-bar { height: 35%; background: #050505; border-top: 1px solid #222; display: flex; align-items: center; justify-content: space-around; }
        .am-item { display: flex; align-items: center; gap: 0.5vw; }
        .d-sub { width: 2.2vw; height: 5vh; }
        .upd-vfd { display: flex; align-items: center; scale: 0.85; }
        .d-upd { width: 1.5vw; height: 3.5vh; }

        /* TICKER SECTION (10%) */
        #bot-section { height: 8vh; display: flex; align-items: center; overflow: hidden; }
        .ticker-wrap { width: 100%; height: 100%; position: relative; }
        .ticker { white-space: nowrap; font-size: 5vh; color: var(--glow-main); line-height: 8vh; position: absolute; left: 100%; text-shadow: var(--discharge); }

        /* ADMIN */
        #admin-trigger { position: fixed; bottom: 5px; right: 5px; opacity: 0.1; cursor: pointer; font-size: 1.5vh; z-index: 100; }
        #admin-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.97); z-index: 101; display: none; align-items: center; justify-content: center; }
        .admin-box { width: 80%; background: #0a0a0c; border: 1px solid #333; padding: 2vh; }
        .slot-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .admin-input { flex: 1; background: #000; border: 1px solid #444; color: #fff; padding: 8px; font-family: inherit; }
    </style>
</head>
<body>

    <div id="top-section" class="bezel">
        <div class="clock-wrapper">
            <div id="date-group" style="display:flex;"></div>
            <div id="time-group" style="display:flex; margin-left:2vw;"></div>
            <div id="sec-group" style="display:flex; margin-left:1.5vw;"></div>
        </div>
    </div>

    <div id="mid-section" class="bezel">
        <div class="h-row"><div class="h-50 active">TODAY</div><div class="h-50">TOMORROW</div></div>
        <div class="weather-grid">
            <div class="card">
                <div class="w-main-row">
                    <div class="w-visual"><div id="ico-0" class="w-icon"></div><div id="txt-0" class="w-text">--</div></div>
                    <div class="w-stats"><div class="temp-line"><div class="label-box hi-label">HI</div><div id="hi-0" style="display:flex;"></div></div></div>
                </div>
                <div class="footer-bar">
                    <div class="am-item"><span class="ui-label">LIVE</span><div id="live-t" style="display:flex;"></div><span class="ui-label">℃</span></div>
                </div>
            </div>
            <div class="card">
                <div class="w-main-row">
                    <div class="w-visual"><div id="ico-1" class="w-icon"></div><div id="txt-1" class="w-text">--</div></div>
                    <div class="w-stats">
                        <div class="temp-line"><div class="label-box hi-label">HI</div><div id="hi-1" style="display:flex;"></div></div>
                        <div class="temp-line"><div class="label-box lo-label">LO</div><div id="lo-1" style="display:flex;"></div></div>
                    </div>
                </div>
                <div class="footer-bar">
                    <div class="upd-vfd"><span class="ui-label">UPD:</span><div id="upd-box" style="display:flex; align-items:center; margin-left:1vw;"></div></div>
                </div>
            </div>
        </div>
    </div>

    <div id="bot-section" class="bezel">
        <div class="ticker-wrap"><div class="ticker" id="ticker-text"></div></div>
    </div>

    <div id="admin-trigger" onclick="toggleAdmin(true)">[ CONFIG ]</div>
    <div id="admin-overlay">
        <div class="admin-box">
            <h2 style="color:var(--glow-main); margin-bottom:15px;">v131.46 CONFIG</h2>
            <div id="inputs-area"></div>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button onclick="saveAll()" style="flex:1; padding:10px; background:var(--glow-main); border:none;">APPLY</button>
                <button onclick="toggleAdmin(false)" style="flex:1; padding:10px; background:#333; color:#fff; border:none;">CANCEL</button>
            </div>
        </div>
    </div>

    <script>
        const MAP = {'0':[1,1,1,1,1,1,0],'1':[0,1,1,0,0,0,0],'2':[1,1,0,1,1,0,1],'3':[1,1,1,1,0,0,1],'4':[0,1,1,0,0,1,1],'5':[1,0,1,1,0,1,1],'6':[1,0,1,1,1,1,1],'7':[1,1,1,0,0,0,0],'8':[1,1,1,1,1,1,1],'9':[1,1,1,1,0,1,1],'-':[0,0,0,0,0,0,1],' ':[0,0,0,0,0,0,0]};
        function build(cls, count) {
            let h = "";
            for(let i=0; i<count; i++) h += `<div class="digit ${cls}">${['a','b','c','d','e','f','g'].map(s=>`<div class="seg seg-${s} ${['a','d','g'].includes(s)?'seg-h':'seg-v'}"></div>`).join('')}</div>`;
            return h;
        }
        function draw(el, s) {
            if (!el) return;
            const ds = el.querySelectorAll('.digit');
            const v = String(s).replace(/[^0-9-]/g, '').padStart(ds.length, ' ');
            for(let i=0; i<ds.length; i++) {
                const pat = MAP[v[i]] || MAP[' '];
                ds[i].querySelectorAll('.seg').forEach((seg, idx) => seg.classList.toggle('on', !!pat[idx]));
            }
        }

        let currentSlot = 1;
        function runTicker() {
            const t = document.getElementById('ticker-text');
            const title = localStorage.getItem(`v_t${currentSlot}`) || "NOTICE";
            const msg = localStorage.getItem(`v_m${currentSlot}`) || "SYSTEM STABILIZED // v131.46 ACTIVE";
            t.innerHTML = `【${title}】 ${msg}`;
            t.style.transition = 'none'; t.style.left = '100%';
            setTimeout(() => {
                const dur = (window.innerWidth + t.offsetWidth) / 90;
                t.style.transition = `left ${dur}s linear`;
                t.style.left = `-${t.offsetWidth}px`;
                setTimeout(() => { currentSlot = currentSlot >= 3 ? 1 : currentSlot + 1; runTicker(); }, dur * 1000 + 500);
            }, 50);
        }

        async function updateWeather() {
            try {
                const [fRes, tRes] = await Promise.all([
                    fetch("https://www.jma.go.jp/bosai/forecast/data/forecast/016000.json"),
                    fetch("https://www.jma.go.jp/bosai/amedas/data/latest_time.txt")
                ]);
                const fData = await fRes.json();
                const tStr = (await tRes.text()).trim();
                const aKey = tStr.replace(/[-T:Z+]/g, '').substring(0, 12) + "00";
                const aRes = await fetch(`https://www.jma.go.jp/bosai/amedas/data/map/${aKey}.json`);
                const aData = await aRes.json();
                const sap = aData["14163"] || {temp:[0]};
                const temps = fData[0].timeSeries[2].areas[0].temps;
                const dt = new Date(tStr);

                for(let i=0; i<2; i++) {
                    const weather = fData[0].timeSeries[0].areas[0].weathers[i];
                    document.getElementById(`txt-${i}`).innerText = weather;
                    document.getElementById(`ico-${i}`).innerText = weather.includes('雪') ? '❄️' : weather.includes('雨') ? '☔' : weather.includes('曇') ? '☁️' : '☀️';
                }

                draw(document.getElementById('hi-0'), temps[0]);
                draw(document.getElementById('hi-1'), temps[3]);
                draw(document.getElementById('lo-1'), temps[2]);
                
                const liveT = sap.temp[0].toFixed(1);
                const liveEl = document.getElementById('live-t');
                draw(liveEl, liveT.split('.')[0]);
                draw(liveEl.querySelectorAll('.digit')[3].parentElement, liveT.split('.')[0]+liveT[1]);

                draw(document.getElementById('upd-box'), (dt.getMonth()+1).toString().padStart(2,'0') + dt.getDate().toString().padStart(2,'0') + dt.getHours().toString().padStart(2,'0') + dt.getMinutes().toString().padStart(2,'0'));
            } catch(e) { console.error("Weather Error", e); }
        }

        function toggleAdmin(s) { document.getElementById('admin-overlay').style.display = s ? 'flex' : 'none'; }
        function saveAll() {
            for(let i=1; i<=3; i++) {
                localStorage.setItem(`v_t${i}`, document.getElementById(`it${i}`).value);
                localStorage.setItem(`v_m${i}`, document.getElementById(`im${i}`).value);
            }
            location.reload();
        }

        window.onload = () => {
            // Initializing Fixed UI
            document.getElementById('date-group').innerHTML = build('d-sm', 2) + '<div class="dot-unit dot-date on"></div>' + build('d-sm', 2) + '<div class="dot-unit dot-date on"></div>' + build('d-sm', 2);
            document.getElementById('time-group').innerHTML = build('d-lg', 2) + '<div class="colon-box"><div class="dot-unit dot-time on"></div><div class="dot-unit dot-time on"></div></div>' + build('d-lg', 2);
            document.getElementById('sec-group').innerHTML = build('d-sm', 2);
            
            document.getElementById('hi-0').innerHTML = build('d-temp', 3);
            document.getElementById('hi-1').innerHTML = build('d-temp', 3);
            document.getElementById('lo-1').innerHTML = build('d-temp', 3);
            document.getElementById('live-t').innerHTML = build('d-sub', 3) + '<div class="dot-unit dot-precis on" style="width:0.8vh; height:0.8vh; margin:3.5vh 0.5vw 0 0;"></div>' + build('d-sub', 1);
            document.getElementById('upd-box').innerHTML = build('d-upd', 2) + '<span>/</span>' + build('d-upd', 2) + '<span style="margin:0 1vw">-</span>' + build('d-upd', 4);

            let adminHtml = "";
            for(let i=1; i<=3; i++) {
                adminHtml += `<div class="slot-row">
                    <input id="it${i}" class="admin-input" value="${localStorage.getItem(`v_t${i}`)||''}" placeholder="T${i}">
                    <input id="im${i}" class="admin-input" style="flex:3" value="${localStorage.getItem(`v_m${i}`)||''}" placeholder="MSG${i}">
                </div>`;
            }
            document.getElementById('inputs-area').innerHTML = adminHtml;

            setInterval(() => {
                const n = new Date();
                draw(document.getElementById('date-group'), String(n.getFullYear()).slice(-2)+String(n.getMonth()+1).padStart(2,'0')+String(n.getDate()).padStart(2,'0'));
                draw(document.getElementById('time-group'), String(n.getHours()).padStart(2,'0')+String(n.getMinutes()).padStart(2,'0'));
                draw(document.getElementById('sec-group'), String(n.getSeconds()).padStart(2,'0'));
            }, 1000);

            updateWeather(); runTicker();
            setInterval(updateWeather, 60000);
        };
    </script>
</body>
</html>
